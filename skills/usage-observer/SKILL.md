---
name: usage-observer
description: 当用户在 Claude Code 会话中提到错误、失败、问题、报错、error、exception、bug、失败、不对、错了、有问题等关键词时自动触发。作为"观察者"角色，自动检测并采集团队成员使用 Claude 时遇到的问题数据，包括会话阶段、问题描述、问题类型、相关文档等，为后续分析和改进提供数据基础。此 skill 设计为在 UserPromptSubmit hook 中自动调用，无需用户主动触发，是 Claude 使用分析系统的数据入口。
metadata:
  version: "1.0.0"
  author: "Claude"
  role: "observer"
  system: "claude-usage-analytics"
  trigger_keywords: ["错误", "失败", "问题", "报错", "error", "exception", "bug", "不对", "错了", "有问题", "failed", "fail", "wrong", "issue", "crash", "timeout", "超时", "无法", "不能", "broken"]
---

# Usage Observer - 使用观察者

## Overview

本 Skill 用于**自动检测** Claude Code 会话中的问题和使用情况。当用户在提问中提到错误、失败、问题等关键词时，本 skill 会自动分析对话内容，提取问题信息，然后调用 `usage-recorder` 完成数据记录。

**职责分工：**
- **usage-observer (观察者)**: 自动检测问题，分析会话内容，提取关键信息
- **usage-recorder (记录员)**: 接收 observer 传递的数据，完成实际存储

数据最终存储在用户目录的 `.claude/claude-analysis/` 下，按日期分文件管理，支持增量记录。

## 触发条件（自动）

当用户的提问包含以下**任意关键词**时自动触发：
- 中文：`错误`、`失败`、`问题`、`报错`、`不对`、`错了`、`有问题`、`超时`、`无法`、`不能`
- 英文：`error`、`exception`、`bug`、`failed`、`fail`、`wrong`、`issue`、`crash`、`timeout`、`broken`

**注意**：此 skill 设计为在 `UserPromptSubmit` hook 中自动调用，用户无需主动说出触发词。采集到的数据将交由 `usage-recorder` 完成记录。

## 数据记录字段

每次记录包含以下字段：

| 字段 | 说明 | 来源 |
|------|------|------|
| 时间戳 | 记录创建时间 | 自动生成 |
| 会话阶段 | 当前会话的阶段 | 从对话内容推断或询问用户 |
| 步骤描述 | 执行的具体步骤或使用的提示词 | 从对话内容分析 |
| 问题描述 | 遇到的详细问题 | 从用户提问中提取 |
| 问题类型 | 问题分类 | 自动分类或用户确认 |
| 解决方案 | 如何解决该问题 | 从对话历史分析或标记为待解决 |
| 相关文档 | 相关的文件或文档路径 | 从对话中提取文件路径 |
| Session ID | Claude Code 会话标识 | 从环境变量获取 |
| 耗费时间 | 解决问题花费的时间（分钟） | 询问用户或估算 |
| 优先级 | 问题的重要程度 | 自动判断或询问 |
| 状态 | 问题处理状态 | 已解决/待解决/需跟进 |
| 备注 | 其他补充信息 | 可选 |

## 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│  UserPromptSubmit Hook 触发                                  │
│  (检测到问题关键词)                                          │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: usage-observer 自动分析                            │
│  - 提取问题描述                                              │
│  - 推断会话阶段                                              │
│  - 识别问题类型                                              │
│  - 提取相关文档                                              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: 询问补充信息                                       │
│  - 确认自动分析结果                                          │
│  - 询问耗费时间                                              │
│  - 确认解决状态                                              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: 调用 usage-recorder 完成记录                       │
│  skill:usage-recorder --stage "..." --problem "..." ...      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  数据存储到 ~/.claude/claude-analysis/YYYY-MM-DD.md          │
└─────────────────────────────────────────────────────────────┘
```

### Phase 1: 自动分析对话内容

当检测到触发关键词时，自动执行：

1. **提取问题描述**
   - 分析用户当前提问，提取核心问题描述
   - 保留原始表述以便后续分析

2. **推断会话阶段**
   - 从对话历史分析当前阶段：
     - 需求分析：讨论需求、规划、设计
     - 代码编写：创建文件、编写代码、实现功能
     - 调试：排查问题、修复 bug
     - 测试：运行测试、验证功能
     - 部署：发布、上线、配置环境

3. **提取步骤描述**
   - 分析用户之前的操作步骤
   - 识别使用的工具、命令或 skill

4. **识别相关文档**
   - 从对话中提取提及的文件路径
   - 记录相关的代码文件、配置文件

5. **问题分类**
   - 自动判断问题类型：
     - 工具错误：工具使用不当或工具本身问题
     - 理解偏差：理解需求或上下文有误
     - 执行失败：执行过程中出错（测试失败、构建失败）
     - 性能问题：响应慢或资源占用高
     - 其他：不属于以上类别

6. **判断解决状态**
   - 如果对话中已有解决方案，提取并标记为"已解决"
   - 如果是新问题，标记为"待解决"

### Phase 2: 询问补充信息

自动分析后，向用户确认或询问：

```
检测到您可能遇到了问题，我已自动分析会话内容：

📋 自动识别信息：
- 会话阶段: [推断的阶段]
- 问题描述: [提取的问题]
- 问题类型: [自动分类]
- 相关文档: [提取的文件路径]

❓ 请确认或补充以下信息：
1. 耗费时间大约是多少分钟？（直接回复数字或"不确定"）
2. 这个问题是否已解决？（是/否）
3. 有其他备注信息吗？

如果您不想记录此问题，请回复"跳过"。
```

### Phase 3: 调用 usage-recorder 存储数据

确认用户补充信息后，调用 `usage-recorder` skill 完成数据存储：

```
skill:usage-recorder
参数:
  --stage "代码编写"
  --step "使用 Skill A 生成代码"
  --problem "命令执行超时"
  --type "执行失败"
  --solution "增加超时时间到 60s"
  --docs "package.json"
  --session "session_abc123"
  --time "10"
  --priority "中"
  --status "已解决"
```

**调用方式**：
- 通过 `skill:` 命令调用 usage-recorder
- 传递所有采集到的字段数据
- 由 usage-recorder 负责实际的文件写入和统计更新

**存储路径**：
- Windows: `%USERPROFILE%\.claude\claude-analysis\YYYY-MM-DD.md`
- Mac/Linux: `~/.claude/claude-analysis/YYYY-MM-DD.md`

## 脚本使用

### record_session.py - 记录会话数据

**参数：**
- `--stage` / `-s`: 会话阶段（必需）
- `--step`: 步骤描述
- `--problem` / `-p`: 问题描述（必需）
- `--type` / `-t`: 问题类型
- `--solution`: 解决方案
- `--docs`: 相关文档（逗号分隔）
- `--session`: Session ID
- `--time`: 耗费时间（分钟）
- `--priority`: 优先级（高/中/低）
- `--status`: 状态（已解决/待解决/需跟进）
- `--note`: 备注
- `--date`: 指定日期（格式：YYYY-MM-DD，默认为今天）

## 输出格式

### 文件结构

```
~/.claude/claude-analysis/
├── 2024-01-15.md
├── 2024-01-16.md
├── 2024-01-17.md
└── summary/
    ├── weekly_2024-W03.md
    └── monthly_2024-01.md
```

### Markdown 文件格式

每个日期的 markdown 文件包含：

```markdown
# Claude Code 会话记录 - 2024-01-15

## 概览

- 记录总数: 5
- 总耗时: 120 分钟
- 已解决问题: 4
- 待解决问题: 1

## 问题分布

| 类型 | 数量 |
|------|------|
| 工具错误 | 2 |
| 理解偏差 | 1 |
| 执行失败 | 1 |
| 性能问题 | 1 |

## 详细记录

| 时间戳 | 阶段 | 步骤 | 问题 | 类型 | 解决方案 | 相关文档 | Session ID | 耗时 | 优先级 | 状态 | 备注 |
|--------|------|------|------|------|----------|----------|------------|------|--------|------|------|
| 09:30 | 需求分析 | 分析项目结构 | 文件过多难以定位 | 理解偏差 | 使用 Glob 工具批量查找 | docs/guide.md | session_001 | 20 | 中 | 已解决 | 后续需优化 |
| 10:15 | 代码编写 | 创建 Skill | 描述不够清晰 | 工具错误 | 重写 description 字段 | SKILL.md | session_001 | 30 | 高 | 已解决 | - |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

## 自动采集标记

- 本条记录由 claude-usage-analysis-plugin 自动采集
- 触发关键词: "错误"
- 原始提问: "[用户原始提问内容]"
```

## 示例

### Example 1: 自动触发记录

**User:** "运行测试时报错，提示找不到模块"

**Claude (自动触发采集):**
```
检测到您可能遇到了问题，我已自动分析会话内容：

📋 自动识别信息：
- 会话阶段: 调试
- 问题描述: 运行测试时报错，提示找不到模块
- 问题类型: 执行失败
- 相关文档: 未识别到具体文件

❓ 请确认或补充以下信息：
1. 耗费时间大约是多少分钟？
2. 这个问题是否已解决？
3. 有其他备注信息吗？

回复"跳过"可忽略此次记录。
```

**User:** "10分钟，还没解决"

**Claude (内部调用 usage-recorder):**
```
skill:usage-recorder --stage "调试" --problem "运行测试时报错，提示找不到模块" \
                     --type "执行失败" --time "10" --status "待解决"
```

**Claude (返回给用户):**
```
✅ 已通过 usage-recorder 记录到 2024-01-15.md

| 时间戳 | 阶段 | 问题 | 类型 | 耗时 | 状态 |
|--------|------|------|------|------|------|
| 14:25 | 调试 | 运行测试时报错，提示找不到模块 | 执行失败 | 10 | 待解决 |
```

### Example 2: 从对话历史提取解决方案

**User:** "构建失败了，怎么解决？"

**Claude:** "请检查 node_modules 是否存在，尝试运行 npm install"

**User:** "好的，npm install 后成功了"

**Claude (usage-observer 自动触发采集):**
```
检测到会话中解决了问题：

📋 自动识别信息：
- 会话阶段: 部署/构建
- 问题描述: 构建失败
- 问题类型: 执行失败
- 解决方案: 运行 npm install 安装依赖
- 相关文档: package.json
- 状态: 已解决

❓ 请确认耗费时间：
（直接回复数字分钟数或"不确定"）
```

## 问题类型说明

| 类型 | 说明 | 示例 |
|------|------|------|
| 工具错误 | 工具使用不当或工具本身问题 | Skill 未触发、命令参数错误 |
| 理解偏差 | 理解需求或上下文有误 | 误解用户意图、文件结构理解错误 |
| 执行失败 | 执行过程中出错 | 测试失败、构建失败、命令超时 |
| 性能问题 | 响应慢或资源占用高 | 处理大文件慢、内存不足 |
| 其他 | 不属于以上类别 | 文档不清晰、依赖缺失 |

## 阶段识别规则

从对话内容自动推断会话阶段：

| 关键词 | 推断阶段 |
|--------|----------|
| 需求、设计、规划、分析、结构 | 需求分析 |
| 创建、编写、实现、开发、写代码 | 代码编写 |
| 调试、排查、修复、bug、错误 | 调试 |
| 测试、验证、断言、用例 | 测试 |
| 部署、发布、上线、构建、打包 | 部署 |

## Hook 配置说明

此 skill 设计为在 `UserPromptSubmit` hook 中自动调用。

### 配置方式

通过 `skill-rules.json` 实现关键词与 skill 的绑定：

**skill-rules.json:**
```json
{
  "$schema": "https://code.claude.com/schemas/skill-rules.json",
  "version": "1.0.0",
  "rules": [
    {
      "id": "usage-observer-auto-trigger",
      "name": "Usage Observer Auto Trigger",
      "skill": "usage-analytics:usage-observer",
      "trigger": {
        "type": "keyword",
        "keywords": ["错误", "失败", "问题", "报错", "error", "exception", "bug", ...],
        "match": "any",
        "caseSensitive": false
      },
      "context": {
        "hook": "UserPromptSubmit",
        "priority": 100
      },
      "action": {
        "type": "invoke",
        "params": { "auto_triggered": true }
      }
    }
  ]
}
```

**marketplace.json:**
```json
{
  "plugins": [{
    "name": "usage-analytics",
    "skillRules": "./skill-rules.json"
  }],
  "hooks": {
    "UserPromptSubmit": [{
      "type": "skill-rules",
      "source": "./skill-rules.json"
    }]
  }
}
```

### 规则匹配优先级

| 优先级 | Skill | 触发关键词 |
|--------|-------|-----------|
| 100 | usage-observer | 错误、error、bug 等问题关键词 |
| 90 | usage-recorder | 记录这个问题、record this issue |
| 80 | usage-analyst | 分析使用情况、generate report |
| 70 | usage-coach | 改进建议、best practices |

### Hook 工作原理

1. **触发时机**: 当用户提交 prompt 时
2. **条件判断**: 检查用户输入是否包含关键词列表中的任意一个
3. **自动调用**: 如果匹配，自动调用 `usage-observer` skill
4. **数据采集**: usage-observer 分析会话上下文，提取问题信息
5. **调用 recorder**: usage-observer 调用 `usage-recorder` skill 完成数据存储

### 与 usage-recorder 的协作

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Hook 触发     │────▶│ usage-observer  │────▶│ usage-recorder  │
│  (UserPrompt)   │     │  (分析+采集)     │     │  (存储数据)      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                                               │
        │                                               ▼
        │                                    ┌─────────────────┐
        │                                    │   Markdown 文件  │
        │                                    │ ~/.claude/...   │
        │                                    └─────────────────┘
        │                                               │
        └───────────────────────────────────────────────┘
                          (返回确认信息给用户)
```

**分工说明**:
| Skill | 职责 | 输出 |
|-------|------|------|
| `usage-observer` | 自动检测、分析会话、提取信息、询问补充 | 结构化数据 |
| `usage-recorder` | 接收数据、写入文件、更新统计、生成报告 | 存储文件 |

### 环境变量

Hook 调用时会传入以下环境变量：

| 变量名 | 说明 |
|--------|------|
| `CLAUDE_HOOK_TYPE` | Hook 类型，值为 `UserPromptSubmit` |
| `CLAUDE_USER_INPUT` | 用户的原始输入内容 |
| `CLAUDE_SESSION_ID` | 当前会话 ID |
| `CLAUDE_WORKSPACE` | 当前工作目录 |

### 用户交互流程

当 Hook 触发后，Claude 会：

1. **分析会话内容** - usage-observer 自动提取问题描述、阶段、类型等信息
2. **展示识别结果** - 向用户展示自动分析的结果
3. **询问补充信息** - 请用户确认或补充时间、状态等信息
4. **调用 recorder** - usage-observer 调用 usage-recorder skill 将数据写入文件

示例交互：

```
用户: "运行测试时报错了，提示找不到模块"

[Hook 触发 usage-observer skill]

Claude:
📋 检测到您可能遇到了问题，我已自动分析会话内容：

- 会话阶段: 调试
- 问题描述: 运行测试时报错，提示找不到模块
- 问题类型: 执行失败
- 相关文档: 未识别到具体文件

❓ 请确认或补充：
1. 耗费时间大约是多少分钟？
2. 这个问题是否已解决？
3. 有其他备注信息吗？

回复"跳过"可忽略此次记录。
```

## 依赖

- **usage-recorder**: 本 skill 依赖 `usage-recorder` skill 完成实际的数据存储
- Python 3.7+ (用于 usage-recorder 的脚本执行)
- 无第三方依赖（使用标准库）

## 协作说明

`usage-observer` 与 `usage-recorder` 是紧密协作的两个 skill：

1. **observer 不负责存储**: 只负责检测和分析，不直接操作文件
2. **recorder 负责存储**: 接收 observer 的数据，完成文件写入
3. **可独立使用 recorder**: 用户也可以直接调用 usage-recorder 进行手动记录

这种分工的好处：
- **单一职责**: observer 专注检测，recorder 专注存储
- **可复用**: recorder 可被其他 skill 或用户直接调用
- **可维护**: 存储逻辑集中在一处，便于维护

## 存储位置

数据最终存储位置由 `usage-recorder` 决定：
- Windows: `%USERPROFILE%\.claude\claude-analysis\`
- Mac/Linux: `~/.claude/claude-analysis/`
